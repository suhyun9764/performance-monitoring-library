<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„±ëŠ¥ ëª¨ë‹ˆí„°</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }

    h1 { margin-bottom: 20px; }
    h2 { margin-top: 30px; margin-bottom: 15px; }

    button {
      padding: 10px 20px;
      margin-right: 10px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    th {
      background: #333;
      color: white;
    }

    .request-item {
      background: white;
      margin-bottom: 10px;
      padding: 15px;
      border: 1px solid #ddd;
    }

    .request-header {
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .request-details {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #f9f9f9;
      border-left: 3px solid #333;
    }

    .metric-row {
      padding: 5px 0;
    }

    .fast { color: green; }
    .normal { color: orange; }
    .slow { color: red; }
  </style>
</head>
<body>
<h1>âš¡ ì„±ëŠ¥ ëª¨ë‹ˆí„°</h1>

<button onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
<button onclick="clearMetrics()">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>

<hr>

<!-- ì„±ëŠ¥ í†µê³„ -->
<h2>ğŸ“Š ì„±ëŠ¥ í†µê³„</h2>
<table>
  <tr>
    <th>ì´ ìš”ì²­ ìˆ˜</th>
    <th>í‰ê·  ì‘ë‹µì‹œê°„</th>
    <th>ê°€ì¥ ëŠë¦°</th>
    <th>ê°€ì¥ ë¹ ë¥¸</th>
  </tr>
  <tr>
    <td id="total-requests">0</td>
    <td id="avg-time">0ms</td>
    <td id="slowest-time">0ms</td>
    <td id="fastest-time">0ms</td>
  </tr>
</table>

<!-- Tomcat ìŠ¤ë ˆë“œ í’€ -->
<h2>ğŸ”§ ìŠ¤ë ˆë“œ í’€ ëª¨ë‹ˆí„°ë§</h2>
<table>
  <tr>
    <th>êµ¬ë¶„</th>
    <th>í˜„ì¬ / ìµœëŒ€</th>
    <th>ì‚¬ìš©ë¥ </th>
  </tr>
  <tr>
    <td>ğŸ§µ ìŠ¤ë ˆë“œ</td>
    <td>
      <span id="current-threads">0</span> /
      <span id="max-threads">0</span>
      (í™œì„±: <span id="active-threads">0</span>)
    </td>
    <td id="thread-utilization">0%</td>
  </tr>
  <tr>
    <td>ğŸ”Œ ì—°ê²°</td>
    <td>
      <span id="connections">0</span> /
      <span id="max-connections">0</span>
    </td>
    <td id="connection-utilization">0%</td>
  </tr>
  <tr>
    <td>âš¡ í™œì„±ë¥ </td>
    <td colspan="2" id="active-rate">0%</td>
  </tr>
</table>

<!-- ìµœê·¼ ìš”ì²­ -->
<h2>ğŸ“‹ ìµœê·¼ ìš”ì²­</h2>
<div id="requests-list">
  <p>ì•„ì§ ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>
</div>

<script>
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨
  window.addEventListener('DOMContentLoaded', () => {
    refreshData();
  });

  async function refreshData() {
    try {
      // ë©”íŠ¸ë¦­ ë°ì´í„°
      const metricsResponse = await fetch('/performance/api/metrics');
      const requests = await metricsResponse.json();

      // Tomcat ìŠ¤ë ˆë“œ í’€ ìƒíƒœ
      const poolResponse = await fetch('/performance/api/thread-pool');
      const threadPool = await poolResponse.json();

      updateStats(requests);
      updateThreadPool(threadPool);
      updateRequestsList(requests);

    } catch (error) {
      console.error('Failed to load data:', error);
    }
  }

  async function clearMetrics() {
    if (!confirm('ëª¨ë“  ë©”íŠ¸ë¦­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      await fetch('/performance/api/clear');
      refreshData();
    } catch (error) {
      console.error('Failed to clear metrics:', error);
    }
  }

  function updateStats(requests) {
    const totalRequests = requests.length;
    document.getElementById('total-requests').textContent = totalRequests;

    if (totalRequests === 0) {
      document.getElementById('avg-time').textContent = '0ms';
      document.getElementById('slowest-time').textContent = '0ms';
      document.getElementById('fastest-time').textContent = '0ms';
      return;
    }

    const times = requests.map(r => r.totalExecutionTime);
    const avgTime = Math.round(times.reduce((a, b) => a + b, 0) / times.length);
    const slowestTime = Math.max(...times);
    const fastestTime = Math.min(...times);

    document.getElementById('avg-time').textContent = avgTime + 'ms';
    document.getElementById('slowest-time').textContent = slowestTime + 'ms';
    document.getElementById('fastest-time').textContent = fastestTime + 'ms';
  }

  function updateThreadPool(stats) {
    document.getElementById('current-threads').textContent = stats.currentThreads;
    document.getElementById('max-threads').textContent = stats.maxThreads;
    document.getElementById('active-threads').textContent = stats.activeThreads;
    document.getElementById('connections').textContent = stats.connectionCount.toLocaleString();
    document.getElementById('max-connections').textContent = stats.maxConnections.toLocaleString();

    document.getElementById('thread-utilization').textContent = stats.threadUtilization.toFixed(1) + '%';
    document.getElementById('connection-utilization').textContent = stats.connectionUtilization.toFixed(1) + '%';
    document.getElementById('active-rate').textContent = stats.threadActiveRate.toFixed(1) + '%';
  }

  function updateRequestsList(requests) {
    const container = document.getElementById('requests-list');

    if (requests.length === 0) {
      container.innerHTML = '<p>ì•„ì§ ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      return;
    }

    // ìµœì‹ ìˆœ ì •ë ¬
    requests.sort((a, b) => {
      const timeA = new Date(a.metrics[0]?.timestamp || 0);
      const timeB = new Date(b.metrics[0]?.timestamp || 0);
      return timeB - timeA;
    });

    container.innerHTML = requests.map(request => createRequestItem(request)).join('');
  }

  function createRequestItem(request) {
    const url = request.requestUrl || 'UNKNOWN';
    const totalTime = request.totalExecutionTime || 0;
    const timeClass = getTimeClass(totalTime);

    return `
                <div class="request-item">
                    <div class="request-header" onclick="toggleDetails('${request.traceId}')">
                        â–¶ [${url}] - <span class="${timeClass}">${totalTime}ms</span>
                    </div>
                    <div class="request-details" id="details-${request.traceId}">
                        ${createMetricsTree(request.metrics)}
                    </div>
                </div>
            `;
  }

  function createMetricsTree(metrics) {
    if (!metrics || metrics.length === 0) {
      return '<p>ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }

    // depthë¡œ ì •ë ¬
    const sorted = [...metrics].sort((a, b) => a.depth - b.depth);

    return sorted.map(metric => {
      const indent = '&nbsp;&nbsp;'.repeat(metric.depth * 2);
      const selfTime = metric.selfExecutionTime || 0;
      const timeClass = getTimeClass(selfTime);

      return `
                    <div class="metric-row">
                        ${indent}[${metric.layer}] ${metric.className}.${metric.methodName}() -
                        <span class="${timeClass}">${selfTime}ms</span>
                    </div>
                `;
    }).join('');
  }

  function toggleDetails(traceId) {
    const details = document.getElementById('details-' + traceId);
    if (details.style.display === 'none' || details.style.display === '') {
      details.style.display = 'block';
    } else {
      details.style.display = 'none';
    }
  }

  function getTimeClass(time) {
    if (time < 50) return 'fast';
    if (time < 200) return 'normal';
    return 'slow';
  }
</script>
</body>
</html>

<!--<!DOCTYPE html>-->
<!--<html lang="ko">-->
<!--<head>-->
<!--  <meta charset="UTF-8">-->
<!--  <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--  <title>ì„±ëŠ¥ ëª¨ë‹ˆí„°</title>-->
<!--  <style>-->
<!--    body {-->
<!--      font-family: Arial, sans-serif;-->
<!--      margin: 20px;-->
<!--      background: #f5f5f5;-->
<!--    }-->

<!--    h1 { margin-bottom: 20px; }-->
<!--    h2 { margin-top: 30px; margin-bottom: 15px; }-->

<!--    button {-->
<!--      padding: 10px 20px;-->
<!--      margin-right: 10px;-->
<!--      cursor: pointer;-->
<!--    }-->

<!--    table {-->
<!--      width: 100%;-->
<!--      border-collapse: collapse;-->
<!--      background: white;-->
<!--      margin-bottom: 20px;-->
<!--    }-->

<!--    th, td {-->
<!--      border: 1px solid #ddd;-->
<!--      padding: 12px;-->
<!--      text-align: left;-->
<!--    }-->

<!--    th {-->
<!--      background: #333;-->
<!--      color: white;-->
<!--    }-->

<!--    .request-item {-->
<!--      background: white;-->
<!--      margin-bottom: 10px;-->
<!--      padding: 15px;-->
<!--      border: 1px solid #ddd;-->
<!--    }-->

<!--    .request-item.n-plus-one {-->
<!--      border-left: 4px solid #ff4444;-->
<!--      background: #fff8f8;-->
<!--    }-->

<!--    .request-header {-->
<!--      cursor: pointer;-->
<!--      font-weight: bold;-->
<!--      margin-bottom: 10px;-->
<!--      display: flex;-->
<!--      align-items: center;-->
<!--      gap: 10px;-->
<!--    }-->

<!--    .request-details {-->
<!--      display: none;-->
<!--      margin-top: 10px;-->
<!--      padding: 10px;-->
<!--      background: #f9f9f9;-->
<!--      border-left: 3px solid #333;-->
<!--    }-->

<!--    .metric-row {-->
<!--      padding: 5px 0;-->
<!--      display: flex;-->
<!--      align-items: center;-->
<!--      gap: 10px;-->
<!--    }-->

<!--    .query-info {-->
<!--      margin-left: 10px;-->
<!--      padding: 3px 8px;-->
<!--      background: #e3f2fd;-->
<!--      border-radius: 3px;-->
<!--      font-size: 0.9em;-->
<!--      color: #1976d2;-->
<!--    }-->

<!--    .n-plus-one-badge {-->
<!--      padding: 3px 8px;-->
<!--      background: #ff4444;-->
<!--      color: white;-->
<!--      border-radius: 3px;-->
<!--      font-size: 0.85em;-->
<!--      font-weight: bold;-->
<!--    }-->

<!--    .n-plus-one-alert {-->
<!--      margin-top: 10px;-->
<!--      padding: 12px;-->
<!--      background: #fff3cd;-->
<!--      border-left: 4px solid #ff9800;-->
<!--      border-radius: 4px;-->
<!--    }-->

<!--    .n-plus-one-alert strong {-->
<!--      color: #d32f2f;-->
<!--    }-->

<!--    .fast { color: green; }-->
<!--    .normal { color: orange; }-->
<!--    .slow { color: red; }-->

<!--    .badge {-->
<!--      padding: 2px 6px;-->
<!--      border-radius: 3px;-->
<!--      font-size: 0.8em;-->
<!--      font-weight: bold;-->
<!--    }-->

<!--    .badge-service { background: #4caf50; color: white; }-->
<!--    .badge-repository { background: #2196f3; color: white; }-->
<!--    .badge-controller { background: #ff9800; color: white; }-->
<!--  </style>-->
<!--</head>-->
<!--<body>-->
<!--<h1>âš¡ ì„±ëŠ¥ ëª¨ë‹ˆí„°</h1>-->

<!--<button onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>-->
<!--<button onclick="clearMetrics()">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>-->

<!--<hr>-->

<!--&lt;!&ndash; ì„±ëŠ¥ í†µê³„ &ndash;&gt;-->
<!--<h2>ğŸ“Š ì„±ëŠ¥ í†µê³„</h2>-->
<!--<table>-->
<!--  <tr>-->
<!--    <th>ì´ ìš”ì²­ ìˆ˜</th>-->
<!--    <th>í‰ê·  ì‘ë‹µì‹œê°„</th>-->
<!--    <th>ê°€ì¥ ëŠë¦°</th>-->
<!--    <th>ê°€ì¥ ë¹ ë¥¸</th>-->
<!--    <th>N+1 ë°œìƒ</th>-->
<!--  </tr>-->
<!--  <tr>-->
<!--    <td id="total-requests">0</td>-->
<!--    <td id="avg-time">0ms</td>-->
<!--    <td id="slowest-time">0ms</td>-->
<!--    <td id="fastest-time">0ms</td>-->
<!--    <td id="n-plus-one-count">0ê±´</td>-->
<!--  </tr>-->
<!--</table>-->

<!--&lt;!&ndash; Tomcat ìŠ¤ë ˆë“œ í’€ &ndash;&gt;-->
<!--<h2>ğŸ”§ ìŠ¤ë ˆë“œ í’€ ëª¨ë‹ˆí„°ë§</h2>-->
<!--<table>-->
<!--  <tr>-->
<!--    <th>êµ¬ë¶„</th>-->
<!--    <th>í˜„ì¬ / ìµœëŒ€</th>-->
<!--    <th>ì‚¬ìš©ë¥ </th>-->
<!--  </tr>-->
<!--  <tr>-->
<!--    <td>ğŸ§µ ìŠ¤ë ˆë“œ</td>-->
<!--    <td>-->
<!--      <span id="current-threads">0</span> /-->
<!--      <span id="max-threads">0</span>-->
<!--      (í™œì„±: <span id="active-threads">0</span>)-->
<!--    </td>-->
<!--    <td id="thread-utilization">0%</td>-->
<!--  </tr>-->
<!--  <tr>-->
<!--    <td>ğŸ”Œ ì—°ê²°</td>-->
<!--    <td>-->
<!--      <span id="connections">0</span> /-->
<!--      <span id="max-connections">0</span>-->
<!--    </td>-->
<!--    <td id="connection-utilization">0%</td>-->
<!--  </tr>-->
<!--  <tr>-->
<!--    <td>âš¡ í™œì„±ë¥ </td>-->
<!--    <td colspan="2" id="active-rate">0%</td>-->
<!--  </tr>-->
<!--</table>-->

<!--&lt;!&ndash; ìµœê·¼ ìš”ì²­ &ndash;&gt;-->
<!--<h2>ğŸ“‹ ìµœê·¼ ìš”ì²­</h2>-->
<!--<div id="requests-list">-->
<!--  <p>ì•„ì§ ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>-->
<!--</div>-->

<!--<script>-->
<!--  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨-->
<!--  window.addEventListener('DOMContentLoaded', () => {-->
<!--    refreshData();-->
<!--  });-->

<!--  async function refreshData() {-->
<!--    try {-->
<!--      // ë©”íŠ¸ë¦­ ë°ì´í„°-->
<!--      const metricsResponse = await fetch('/performance/api/metrics');-->
<!--      const requests = await metricsResponse.json();-->

<!--      // Tomcat ìŠ¤ë ˆë“œ í’€ ìƒíƒœ-->
<!--      const poolResponse = await fetch('/performance/api/thread-pool');-->
<!--      const threadPool = await poolResponse.json();-->

<!--      updateStats(requests);-->
<!--      updateThreadPool(threadPool);-->
<!--      updateRequestsList(requests);-->

<!--    } catch (error) {-->
<!--      console.error('Failed to load data:', error);-->
<!--    }-->
<!--  }-->

<!--  async function clearMetrics() {-->
<!--    if (!confirm('ëª¨ë“  ë©”íŠ¸ë¦­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {-->
<!--      return;-->
<!--    }-->

<!--    try {-->
<!--      await fetch('/performance/api/clear');-->
<!--      refreshData();-->
<!--    } catch (error) {-->
<!--      console.error('Failed to clear metrics:', error);-->
<!--    }-->
<!--  }-->

<!--  function updateStats(requests) {-->
<!--    const totalRequests = requests.length;-->
<!--    document.getElementById('total-requests').textContent = totalRequests;-->

<!--    if (totalRequests === 0) {-->
<!--      document.getElementById('avg-time').textContent = '0ms';-->
<!--      document.getElementById('slowest-time').textContent = '0ms';-->
<!--      document.getElementById('fastest-time').textContent = '0ms';-->
<!--      document.getElementById('n-plus-one-count').textContent = '0ê±´';-->
<!--      return;-->
<!--    }-->

<!--    const times = requests.map(r => r.totalExecutionTime);-->
<!--    const avgTime = Math.round(times.reduce((a, b) => a + b, 0) / times.length);-->
<!--    const slowestTime = Math.max(...times);-->
<!--    const fastestTime = Math.min(...times);-->

<!--    // N+1 ë°œìƒ ê±´ìˆ˜ ê³„ì‚°-->
<!--    const nPlusOneCount = requests.filter(r =>-->
<!--            r.metrics.some(m => m.hasNPlusOne)-->
<!--    ).length;-->

<!--    document.getElementById('avg-time').textContent = avgTime + 'ms';-->
<!--    document.getElementById('slowest-time').textContent = slowestTime + 'ms';-->
<!--    document.getElementById('fastest-time').textContent = fastestTime + 'ms';-->
<!--    document.getElementById('n-plus-one-count').textContent = nPlusOneCount + 'ê±´';-->
<!--    document.getElementById('n-plus-one-count').style.color = nPlusOneCount > 0 ? '#ff4444' : 'inherit';-->
<!--  }-->

<!--  function updateThreadPool(stats) {-->
<!--    document.getElementById('current-threads').textContent = stats.currentThreads;-->
<!--    document.getElementById('max-threads').textContent = stats.maxThreads;-->
<!--    document.getElementById('active-threads').textContent = stats.activeThreads;-->
<!--    document.getElementById('connections').textContent = stats.connectionCount.toLocaleString();-->
<!--    document.getElementById('max-connections').textContent = stats.maxConnections.toLocaleString();-->

<!--    document.getElementById('thread-utilization').textContent = stats.threadUtilization.toFixed(1) + '%';-->
<!--    document.getElementById('connection-utilization').textContent = stats.connectionUtilization.toFixed(1) + '%';-->
<!--    document.getElementById('active-rate').textContent = stats.threadActiveRate.toFixed(1) + '%';-->
<!--  }-->

<!--  function updateRequestsList(requests) {-->
<!--    const container = document.getElementById('requests-list');-->

<!--    if (requests.length === 0) {-->
<!--      container.innerHTML = '<p>ì•„ì§ ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>';-->
<!--      return;-->
<!--    }-->

<!--    // ìµœì‹ ìˆœ ì •ë ¬-->
<!--    requests.sort((a, b) => {-->
<!--      const timeA = new Date(a.metrics[0]?.timestamp || 0);-->
<!--      const timeB = new Date(b.metrics[0]?.timestamp || 0);-->
<!--      return timeB - timeA;-->
<!--    });-->

<!--    container.innerHTML = requests.map(request => createRequestItem(request)).join('');-->
<!--  }-->

<!--  function createRequestItem(request) {-->
<!--    const url = request.requestUrl || 'UNKNOWN';-->
<!--    const totalTime = request.totalExecutionTime || 0;-->
<!--    const timeClass = getTimeClass(totalTime);-->

<!--    // N+1 ë°œìƒ ì—¬ë¶€ í™•ì¸-->
<!--    const hasNPlusOne = request.metrics.some(m => m.hasNPlusOne);-->
<!--    const nPlusOneClass = hasNPlusOne ? 'n-plus-one' : '';-->

<!--    return `-->
<!--      <div class="request-item ${nPlusOneClass}">-->
<!--        <div class="request-header" onclick="toggleDetails('${request.traceId}')">-->
<!--          <span>â–¶ [${url}]</span>-->
<!--          <span class="${timeClass}">${totalTime}ms</span>-->
<!--          ${hasNPlusOne ? '<span class="n-plus-one-badge">âš ï¸ N+1</span>' : ''}-->
<!--        </div>-->
<!--        <div class="request-details" id="details-${request.traceId}">-->
<!--          ${createMetricsTree(request.metrics)}-->
<!--        </div>-->
<!--      </div>-->
<!--    `;-->
<!--  }-->

<!--  function createMetricsTree(metrics) {-->
<!--    if (!metrics || metrics.length === 0) {-->
<!--      return '<p>ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>';-->
<!--    }-->

<!--    // depthë¡œ ì •ë ¬-->
<!--    const sorted = [...metrics].sort((a, b) => a.depth - b.depth);-->

<!--    return sorted.map(metric => {-->
<!--      const indent = '&nbsp;&nbsp;'.repeat(metric.depth * 2);-->
<!--      const time = metric.executionTime || 0;-->
<!--      const timeClass = getTimeClass(time);-->

<!--      // ì¿¼ë¦¬ ì •ë³´-->
<!--      const queryInfo = metric.totalQueryCount > 0-->
<!--              ? `<span class="query-info">ğŸ“Š ${metric.totalQueryCount}ê°œ ì¿¼ë¦¬</span>`-->
<!--              : '';-->

<!--      // N+1 ê²½ê³ -->
<!--      const nPlusOneAlert = metric.hasNPlusOne-->
<!--              ? `-->
<!--          <div class="n-plus-one-alert">-->
<!--            <strong>âš ï¸ N+1 ì¿¼ë¦¬ ê°ì§€!</strong><br>-->
<!--            íŒ¨í„´: <code>${metric.nPlusOnePattern}</code><br>-->
<!--            ë°˜ë³µ íšŸìˆ˜: <strong>${metric.nPlusOneCount}íšŒ</strong><br>-->
<!--            ğŸ’¡ í•´ê²°: @EntityGraph ë˜ëŠ” Fetch Join ì‚¬ìš© ê¶Œì¥-->
<!--          </div>-->
<!--        `-->
<!--              : '';-->

<!--      return `-->
<!--        <div class="metric-row">-->
<!--          ${indent}-->
<!--          <span class="badge badge-${metric.layer.toLowerCase()}">${metric.layer}</span>-->
<!--          <span>${metric.className}.${metric.methodName}()</span>-->
<!--          <span class="${timeClass}">${time}ms</span>-->
<!--          ${queryInfo}-->
<!--        </div>-->
<!--        ${nPlusOneAlert}-->
<!--      `;-->
<!--    }).join('');-->
<!--  }-->

<!--  function toggleDetails(traceId) {-->
<!--    const details = document.getElementById('details-' + traceId);-->
<!--    if (details.style.display === 'none' || details.style.display === '') {-->
<!--      details.style.display = 'block';-->
<!--    } else {-->
<!--      details.style.display = 'none';-->
<!--    }-->
<!--  }-->

<!--  function getTimeClass(time) {-->
<!--    if (time < 50) return 'fast';-->
<!--    if (time < 200) return 'normal';-->
<!--    return 'slow';-->
<!--  }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->


