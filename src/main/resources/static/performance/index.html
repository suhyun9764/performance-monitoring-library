<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„±ëŠ¥ ëª¨ë‹ˆí„°</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }

    h1 { margin-bottom: 20px; }
    h2 { margin-top: 30px; margin-bottom: 15px; }

    button {
      padding: 10px 20px;
      margin-right: 10px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #333;
      color: white;
    }

    button:hover { background: #555; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    th {
      background: #333;
      color: white;
    }

    .request-item {
      background: white;
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .request-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .request-item.n-plus-one-possible {
      border-left: 4px solid #ff9800;
    }

    .request-header {
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .request-details {
      display: none;
      margin-top: 15px;
    }

    /* ë©”ì„œë“œ í˜¸ì¶œ íŠ¸ë¦¬ ì˜ì—­ */
    .method-tree {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    .metric-row {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #e0e0e0;
    }

    .metric-row:last-child {
      border-bottom: none;
    }

    /* N+1 ê²½ê³  ì˜ì—­ */
    .n-plus-one-section {
      margin-top: 15px;
      padding: 15px;
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 6px;
    }

    .n-plus-one-section h4 {
      margin: 0 0 15px 0;
      color: #e65100;
      font-size: 1.1em;
    }

    .n-plus-one-item {
      background: white;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 4px;
      border-left: 3px solid #ff9800;
    }

    .n-plus-one-item:last-child {
      margin-bottom: 0;
    }

    .n-plus-one-location {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }

    .n-plus-one-details {
      font-size: 0.95em;
      color: #666;
      line-height: 1.6;
    }

    .n-plus-one-details > div {
      margin-bottom: 5px;
    }

    .n-plus-one-solution {
      margin-top: 10px;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 4px;
      border-left: 3px solid #4caf50;
    }

    /* ì¿¼ë¦¬ ì •ë³´ ë°•ìŠ¤ */
    .query-info-box {
      display: inline-block;
      margin-left: 10px;
      padding: 4px 10px;
      background: #e3f2fd;
      border-radius: 4px;
      font-size: 0.85em;
      color: #1976d2;
    }

    .n-plus-one-badge {
      padding: 4px 10px;
      background: #ff9800;
      color: white;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: bold;
    }

    .fast { color: #4caf50; font-weight: bold; }
    .normal { color: #ff9800; font-weight: bold; }
    .slow { color: #f44336; font-weight: bold; }

    .badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: bold;
      text-transform: uppercase;
    }

    .badge-service { background: #4caf50; color: white; }
    .badge-repository { background: #2196f3; color: white; }
    .badge-controller { background: #ff9800; color: white; }
    .badge-unknown { background: #9e9e9e; color: white; }
  </style>
</head>
<body>
<h1>âš¡ ì„±ëŠ¥ ëª¨ë‹ˆí„°</h1>

<button onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
<button onclick="clearMetrics()">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>

<hr>

<!-- ì„±ëŠ¥ í†µê³„ -->
<h2>ğŸ“Š ì„±ëŠ¥ í†µê³„</h2>
<table>
  <tr>
    <th>ì´ ìš”ì²­ ìˆ˜</th>
    <th>í‰ê·  ì‘ë‹µì‹œê°„</th>
    <th>ê°€ì¥ ëŠë¦°</th>
    <th>ê°€ì¥ ë¹ ë¥¸</th>
    <th>N+1 ê°ì§€</th>
  </tr>
  <tr>
    <td id="total-requests">0</td>
    <td id="avg-time">0ms</td>
    <td id="slowest-time">0ms</td>
    <td id="fastest-time">0ms</td>
    <td id="n-plus-one-count">0ê±´</td>
  </tr>
</table>

<!-- Tomcat ìŠ¤ë ˆë“œ í’€ -->
<h2>ğŸ”§ ìŠ¤ë ˆë“œ í’€ ëª¨ë‹ˆí„°ë§</h2>
<table>
  <tr>
    <th>êµ¬ë¶„</th>
    <th>í˜„ì¬ / ìµœëŒ€</th>
    <th>ì‚¬ìš©ë¥ </th>
  </tr>
  <tr>
    <td>ğŸ§µ ìŠ¤ë ˆë“œ</td>
    <td>
      <span id="current-threads">0</span> /
      <span id="max-threads">0</span>
      (í™œì„±: <span id="active-threads">0</span>)
    </td>
    <td id="thread-utilization">0%</td>
  </tr>
  <tr>
    <td>ğŸ”Œ ì—°ê²°</td>
    <td>
      <span id="connections">0</span> /
      <span id="max-connections">0</span>
    </td>
    <td id="connection-utilization">0%</td>
  </tr>
  <tr>
    <td>âš¡ í™œì„±ë¥ </td>
    <td colspan="2" id="active-rate">0%</td>
  </tr>
</table>

<!-- ìµœê·¼ ìš”ì²­ -->
<h2>ğŸ“‹ ìµœê·¼ ìš”ì²­</h2>
<div id="requests-list">
  <p>ì•„ì§ ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>
</div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    refreshData();
  });

  async function refreshData() {
    try {
      const metricsResponse = await fetch('/performance/api/metrics');
      const requests = await metricsResponse.json();

      const poolResponse = await fetch('/performance/api/thread-pool');
      const threadPool = await poolResponse.json();

      updateStats(requests);
      updateThreadPool(threadPool);
      updateRequestsList(requests);

    } catch (error) {
      console.error('Failed to load data:', error);
    }
  }

  async function clearMetrics() {
    if (!confirm('ëª¨ë“  ë©”íŠ¸ë¦­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      await fetch('/performance/api/clear');
      refreshData();
    } catch (error) {
      console.error('Failed to clear metrics:', error);
    }
  }

  function updateStats(requests) {
    const totalRequests = requests.length;
    document.getElementById('total-requests').textContent = totalRequests;

    if (totalRequests === 0) {
      document.getElementById('avg-time').textContent = '0ms';
      document.getElementById('slowest-time').textContent = '0ms';
      document.getElementById('fastest-time').textContent = '0ms';
      document.getElementById('n-plus-one-count').textContent = '0ê±´';
      return;
    }

    const times = requests.map(r => r.totalExecutionTime);
    const avgTime = Math.round(times.reduce((a, b) => a + b, 0) / times.length);
    const slowestTime = Math.max(...times);
    const fastestTime = Math.min(...times);

    const nPlusOneCount = requests.filter(r =>
            r.metrics.some(m => m.hasNPlusOne === true)
    ).length;

    document.getElementById('avg-time').textContent = avgTime + 'ms';
    document.getElementById('slowest-time').textContent = slowestTime + 'ms';
    document.getElementById('fastest-time').textContent = fastestTime + 'ms';
    document.getElementById('n-plus-one-count').textContent = nPlusOneCount + 'ê±´';
    document.getElementById('n-plus-one-count').style.color = nPlusOneCount > 0 ? '#ff9800' : 'inherit';
  }

  function updateThreadPool(stats) {
    document.getElementById('current-threads').textContent = stats.currentThreads;
    document.getElementById('max-threads').textContent = stats.maxThreads;
    document.getElementById('active-threads').textContent = stats.activeThreads;
    document.getElementById('connections').textContent = stats.connectionCount.toLocaleString();
    document.getElementById('max-connections').textContent = stats.maxConnections.toLocaleString();

    document.getElementById('thread-utilization').textContent = stats.threadUtilization.toFixed(1) + '%';
    document.getElementById('connection-utilization').textContent = stats.connectionUtilization.toFixed(1) + '%';
    document.getElementById('active-rate').textContent = stats.threadActiveRate.toFixed(1) + '%';
  }

  function updateRequestsList(requests) {
    const container = document.getElementById('requests-list');

    if (requests.length === 0) {
      container.innerHTML = '<p>ì•„ì§ ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      return;
    }

    requests.sort((a, b) => {
      const timeA = new Date(a.metrics[0]?.timestamp || 0);
      const timeB = new Date(b.metrics[0]?.timestamp || 0);
      return timeB - timeA;
    });

    container.innerHTML = requests.map(request => createRequestItem(request)).join('');
  }

  function createRequestItem(request) {
    const url = request.requestUrl || 'UNKNOWN';
    const totalTime = request.totalExecutionTime || 0;
    const timeClass = getTimeClass(totalTime);

    const hasNPlusOne = request.metrics.some(m => m.hasNPlusOne === true);
    const nPlusOneClass = hasNPlusOne ? 'n-plus-one-possible' : '';

    return `
      <div class="request-item ${nPlusOneClass}">
        <div class="request-header" onclick="toggleDetails('${request.traceId}')">
          <span>â–¶ [${url}]</span>
          <span class="${timeClass}">${totalTime}ms</span>
          ${hasNPlusOne ? '<span class="n-plus-one-badge">âš ï¸ N+1 ê°ì§€</span>' : ''}
        </div>
        <div class="request-details" id="details-${request.traceId}">
          ${createMetricsView(request.metrics)}
        </div>
      </div>
    `;
  }

  function createMetricsView(metrics) {
    if (!metrics || metrics.length === 0) {
      return '<p>ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }

    const sorted = [...metrics].sort((a, b) => a.depth - b.depth);

    const methodTree = createMethodTree(sorted);
    const nPlusOneSection = createNPlusOneSection(sorted);

    return `
      <div class="method-tree">
        <h4 style="margin: 0 0 15px 0; color: #666;">ğŸ“Š ë©”ì„œë“œ í˜¸ì¶œ íŠ¸ë¦¬</h4>
        ${methodTree}
      </div>
      ${nPlusOneSection}
    `;
  }

  function createMethodTree(metrics) {
    return metrics.map(metric => {
      const indent = '&nbsp;&nbsp;'.repeat(metric.depth * 2);
      const time = metric.executionTime || 0;
      const timeClass = getTimeClass(time);

      const queryBadge = (metric.totalQueryCount > 0)
              ? `<span class="query-info-box">ğŸ“Š ${metric.totalQueryCount}ê°œ ì¿¼ë¦¬</span>`
              : '';

      return `
        <div class="metric-row">
          ${indent}
          <span class="badge badge-${(metric.layer || 'unknown').toLowerCase()}">${metric.layer || 'UNKNOWN'}</span>
          <span>${metric.className}.${metric.methodName}()</span>
          <span class="${timeClass}">${time}ms</span>
          ${queryBadge}
        </div>
      `;
    }).join('');
  }

  function createNPlusOneSection(metrics) {
    const nPlusOneMetrics = metrics.filter(m => m.hasNPlusOne === true);

    if (nPlusOneMetrics.length === 0) {
      return '';
    }

    const items = nPlusOneMetrics.map(metric => {
      const issues = metric.nplusOneIssues || [];

      if (issues.length === 0) {
        return '';
      }

      const issuesList = issues.map((issue, idx) => `
        <div class="n-plus-one-item">
          <div class="n-plus-one-location">
            ğŸ“ ${metric.className}.${metric.methodName}() - N+1 íŒ¨í„´ #${idx + 1}
          </div>
          <div class="n-plus-one-details">
            <div><strong>íŒ¨í„´:</strong></div>
            <div><code style="font-size: 0.85em; word-break: break-all; display: block; background: #f5f5f5; padding: 8px; border-radius: 4px; margin: 5px 0;">${issue.pattern}</code></div>
            <div><strong>ë°˜ë³µ íšŸìˆ˜:</strong> <span style="color: #ff9800; font-weight: bold;">${issue.count}íšŒ</span></div>
            <div><strong>ì „ì²´ ì¿¼ë¦¬:</strong> ${metric.totalQueryCount || 0}ê°œ ì¤‘ ${((issue.count / metric.totalQueryCount) * 100).toFixed(1)}%</div>
          </div>
          <div class="n-plus-one-solution">
            ğŸ’¡ <strong>ê¶Œì¥ í•´ê²°ë°©ë²•:</strong> ${issue.suggestion || '@EntityGraph ë˜ëŠ” Fetch Join ì‚¬ìš©'}
          </div>
        </div>
      `).join('');

      return issuesList;
    }).join('');

    const totalIssues = nPlusOneMetrics.reduce((sum, m) => sum + (m.nplusOneIssues?.length || 0), 0);

    return `
    <div class="n-plus-one-section">
      <h4>âš ï¸ N+1 ì¿¼ë¦¬ ê°ì§€ (${totalIssues}ê°œ íŒ¨í„´)</h4>
      ${items}
    </div>
  `;
  }

  function toggleDetails(traceId) {
    const details = document.getElementById('details-' + traceId);
    if (details.style.display === 'none' || details.style.display === '') {
      details.style.display = 'block';
    } else {
      details.style.display = 'none';
    }
  }

  function getTimeClass(time) {
    if (time < 50) return 'fast';
    if (time < 200) return 'normal';
    return 'slow';
  }
</script>
</body>
</html>